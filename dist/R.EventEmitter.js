"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
module.exports = function (R) {
  var _ = require("lodash");
  var assert = require("assert");

  /**
  * <p>R.EventEmitter is similar to R.Store. <br />
  * Event Emitters are event-oriented stores without persistence. <br />
  * It juste provides a slightly different abstraction, that is sometimes more suited.</p>
  * @class R.EventEmitter
  */
  var EventEmitter = {
    /**
    * <p> Returns a new EventEmitter constructor
    * @method createEventEmitter
    * @param {object} specs The specifications
    * @return {object} EventEmitterInstance The created EventEmitterInstance
    */
    createEventEmitter: function createEventEmitter(specs) {
      R.Debug.dev(function () {
        assert(_.isObject(specs), "R.EventEmitter.createEventEmitter(...): expecting an Object as specs.");
        assert(_.has(specs, "displayName") && _.isString(specs.displayName), "R.EventEmitter.createEventEmitter(...): requires displayName(String).");
        assert(_.has(specs, "addListener") && _.isFunction(specs.addListener), "R.EventEmitter.createEventEmitter(...): requires addListener(String, Function): R.EventEmitter.Listener.");
        assert(_.has(specs, "removeListener") && _.isFunction(specs.removeListener), "R.EventEmitter.createEventEmitter(...)");
      });
      /**
       * @memberOf R.EventEmitter
       * @public
       */
      var EventEmitterInstance = function EventEmitterInstance() {};
      _.extend(EventEmitterInstance.prototype, specs, {
        /**
         *  Type dirty-checking.
         *  @private
         *  @readOnly
         */
        _isEventEmitterInstance_: true });
      return EventEmitterInstance;
    },
    Listener: function Listener(event) {
      this.uniqueId = _.uniqueId("R.EventEmitter.Listener");
      this.event = event;
    },
    /**
    * <p> Returns a new MemoryEventEmitter that represents a memory-local store, eg. clicks, window events.</p>
    * @method createMemoryEventEmitter
    * @return {object} MemoryEventEmitter The created MemoryEventEmitter instance
    */
    createMemoryEventEmitter: function createMemoryEventEmitter() {
      return function MemoryEventEmitter() {
        var listeners = {};
        var addListener = function addListener(event, fn) {
          var listener = new R.EventEmitter.Listener(event);
          if (!_.has(listeners, event)) {
            listeners[event] = {};
          }
          listeners[event][listener.uniqueId] = fn;
          return listener;
        };
        var removeListener = function removeListener(listener) {
          R.Debug.dev(function () {
            assert(listener instanceof R.EventEmitter.Listener, "R.EventEmitter.MemoryEventEmitter.removeListener(...): type R.EventEmitter.Listener expected.");
            assert(_.has(listeners, listener.event), "R.EventEmitter.MemoryEventEmitter.removeListener(...): no listeners for this event.");
            assert(_.has(listeners[listener.event], listener.uniqueId), "R.EventEmitter.MemoryEventEmitter.removeListener(...): no such listener.");
          });
          delete listeners[listener.event][listener.uniqueId];
          if (_.size(listeners[listener.event]) === 0) {
            delete listeners[listener.event];
          }
        };
        var emit = function emit(event, params) {
          params = params || {};
          if (_.has(listeners, event)) {
            _.each(listeners[event], function (fn) {
              if (fn) {
                fn(params);
              }
            });
          }
        };
        return new (R.EventEmitter.createEventEmitter({
          displayName: "MemoryEventEmitter",
          addListener: addListener,
          removeListener: removeListener,
          emit: emit }))();
      };
    },
    /**
    * <p> Returns a new UplinkEventEmitter that represents a remote event emmiter, eg. global notifications, broadcasts. </p>
    * @method createUplinkEventEmitter
    * @return {object} UplinkEventEmitter The created UplinkEventEmitter instance
    */
    createUplinkEventEmitter: function createUplinkEventEmitter() {
      return function UplinkEventEmitter(uplink) {
        R.Debug.dev(function () {
          assert(uplink.listenTo && _.isFunction(uplink.listenTo), "R.EventEmitter.createUplinkEventEmitter(...).uplink.listenTo: expecting Function.");
          assert(uplink.unlistenFrom && _.isFunction(uplink.unlistenFrom), "R.EventEmitter.createUplinkEventEmitter(...).uplink.unlistenFrom: expecting Function.");
        });
        var listenTo = uplink.listenTo;
        var unlistenFrom = uplink.unlistenFrom;
        var listeners = {};
        var emitters = {};
        var addListener = function addListener(event, fn) {
          var listener = new R.EventEmitter.Listener(event);
          if (!_.has(listeners, event)) {
            emitters[event] = listenTo(event, _.partial(emit, event));
            listeners[event] = {};
          }
          listeners[event][listener.uniqueId] = fn;
          return listener;
        };
        var removeListener = function removeListener(listener) {
          R.Debug.dev(function () {
            assert(listener instanceof R.EventEmitter.Listener, "R.EventEmitter.UplinkEventEmitter.removeListener(...): type R.EventEmitter.Listener expected.");
            assert(_.has(listeners, listener.event), "R.EventEmitter.UplinkEventEmitter.removeListener(...): no listeners for this event.");
            assert(_.has(listeners[listener.event], listener.uniqueId), "R.EventEmitter.UplinkEventEmitter.removeListener(...): no such listener.");
          });
          delete listeners[listener.event][listener.uniqueId];
          if (_.size(listeners[listener.event]) === 0) {
            unlistenFrom(listener.event, emitters[event]);
            delete listeners[listener.event];
            delete emitters[listener.event];
          }
        };
        var emit = function emit(event, params) {
          params = params || {};
          if (_.has(listeners, event)) {
            _.each(listeners[event], function (fn) {
              if (fn) {
                fn(params);
              }
            });
          }
        };
        return new (R.EventEmitter.createEventEmitter({
          displayName: "UplinkEventEmitter",
          addListener: addListener,
          removeListener: removeListener }))();
      };
    } };

  _.extend(EventEmitter.Listener.prototype, /** @lends R.EventEmitter.Listener.prototype */{
    /**
     * @property uniqueId
     * @type {String}
     * @public
     * @readOnly
     */
    uniqueId: null,
    /**
     * @property event
     * @type {String}
     * @public
     * @readOnly
     */
    event: null });

  return EventEmitter;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImQ6L3dvcmtzcGFjZV9yZWZhY3Rvci9yZWFjdC1yYWlscy9zcmMvUi5FdmVudEVtaXR0ZXIuanMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxPQUFPLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDekIsSUFBTSxPQUFPLEdBQUcsT0FBTyxDQUFDLFVBQVUsQ0FBQyxDQUFDO0FBQ3BDLE1BQU0sQ0FBQyxPQUFPLEdBQUcsVUFBUyxDQUFDLEVBQUU7QUFDekIsTUFBSSxDQUFDLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQzFCLE1BQUksTUFBTSxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzs7Ozs7Ozs7QUFRL0IsTUFBSSxZQUFZLEdBQUc7Ozs7Ozs7QUFPZixzQkFBa0IsRUFBRSxTQUFTLGtCQUFrQixDQUFDLEtBQUssRUFBRTtBQUNuRCxPQUFDLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxZQUFXO0FBQ25CLGNBQU0sQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLHVFQUF1RSxDQUFDLENBQUM7QUFDbkcsY0FBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLHVFQUF1RSxDQUFDLENBQUM7QUFDOUksY0FBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLGFBQWEsQ0FBQyxJQUFJLENBQUMsQ0FBQyxVQUFVLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxFQUFFLDBHQUEwRyxDQUFDLENBQUM7QUFDbkwsY0FBTSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLGdCQUFnQixDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxLQUFLLENBQUMsY0FBYyxDQUFDLEVBQUUsd0NBQXdDLENBQUMsQ0FBQztPQUMxSCxDQUFDLENBQUM7Ozs7O0FBS0gs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eEIsYUFBQyxDQUFDLElBQUksQ0FBQyxTQUFTLENBQUMsS0FBSyxDQUFDLEVBQUUsVUFBUyxFQUFFLEVBQUU7QUFDbEMsa0JBQUcsRUFBRSxFQUFFO0FBQ0gsa0JBQUUsQ0FBQyxNQUFNLENBQUMsQ0FBQztlQUNkO2FBQ0osQ0FBQyxDQUFDO1dBQ047U0FDSixDQUFDO0FBQ0YsZUFBTyxJQUFJLENBQUMsQ0FBQyxDQUFDLFlBQVksQ0FBQyxrQkFBa0IsQ0FBQztBQUMxQyxxQkFBVyxFQUFFLG9CQUFvQjtBQUNqQyxxQkFBVyxFQUFFLFdBQVc7QUFDeEIsd0JBQWMsRUFBRSxjQUFjLEVBQ2pDLENBQUMsQ0FBQyxFQUFFLENBQUM7T0FDVCxDQUFDO0tBQ0wsRUFDSixDQUFDOztBQUVGLEdBQUMsQ0FBQyxNQUFNLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxTQUFTLGlEQUFrRDs7Ozs7OztBQU90RixZQUFRLEVBQUUsSUFBSTs7Ozs7OztBQU9kLFNBQUssRUFBRSxJQUFJLEVBQ2QsQ0FBQyxDQUFDOztBQUVILFNBQU8sWUFBWSxDQUFDO0NBQ3ZCLENBQUMiLCJmaWxlIjoiUi5FdmVudEVtaXR0ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCc2dG81L3BvbHlmaWxsJyk7XG5jb25zdCBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUikge1xyXG4gICAgdmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG4gICAgdmFyIGFzc2VydCA9IHJlcXVpcmUoXCJhc3NlcnRcIik7XHJcblxyXG4gICAgLyoqXHJcbiAgICAqIDxwPlIuRXZlbnRFbWl0dGVyIGlzIHNpbWlsYXIgdG8gUi5TdG9yZS4gPGJyIC8+XHJcbiAgICAqIEV2ZW50IEVtaXR0ZXJzIGFyZSBldmVudC1vcmllbnRlZCBzdG9yZXMgd2l0aG91dCBwZXJzaXN0ZW5jZS4gPGJyIC8+XHJcbiAgICAqIEl0IGp1c3RlIHByb3ZpZGVzIGEgc2xpZ2h0bHkgZGlmZmVyZW50IGFic3RyYWN0aW9uLCB0aGF0IGlzIHNvbWV0aW1lcyBtb3JlIHN1aXRlZC48L3A+XHJcbiAgICAqIEBjbGFzcyBSLkV2ZW50RW1pdHRlclxyXG4gICAgKi9cclxuICAgIHZhciBFdmVudEVtaXR0ZXIgPSB7XHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgKiA8cD4gUmV0dXJucyBhIG5ldyBFdmVudEVtaXR0ZXIgY29uc3RydWN0b3JcclxuICAgICAgICAqIEBtZXRob2QgY3JlYXRlRXZlbnRFbWl0dGVyXHJcbiAgICAgICAgKiBAcGFyYW0ge29iamVjdH0gc3BlY3MgVGhlIHNwZWNpZmljYXRpb25zXHJcbiAgICAgICAgKiBAcmV0dXJuIHtvYmplY3R9IEV2ZW50RW1pdHRlckluc3RhbmNlIFRoZSBjcmVhdGVkIEV2ZW50RW1pdHRlckluc3RhbmNlXHJcbiAgICAgICAgKi9cclxuICAgICAgICBjcmVhdGVFdmVudEVtaXR0ZXI6IGZ1bmN0aW9uIGNyZWF0ZUV2ZW50RW1pdHRlcihzcGVjcykge1xyXG4gICAgICAgICAgICBSLkRlYnVnLmRldihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGFzc2VydChfLmlzT2JqZWN0KHNwZWNzKSwgXCJSLkV2ZW50RW1pdHRlci5jcmVhdGVFdmVudEVtaXR0ZXIoLi4uKTogZXhwZWN0aW5nIGFuIE9iamVjdCBhcyBzcGVjcy5cIik7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnQoXy5oYXMoc3BlY3MsIFwiZGlzcGxheU5hbWVcIikgJiYgXy5pc1N0cmluZyhzcGVjcy5kaXNwbGF5TmFtZSksIFwiUi5FdmVudEVtaXR0ZXIuY3JlYXRlRXZlbnRFbWl0dGVyKC4uLik6IHJlcXVpcmVzIGRpc3BsYXlOYW1lKFN0cmluZykuXCIpO1xyXG4gICAgICAgICAgICAgICAgYXNzZXJ0KF8uaGFzKHNwZWNzLCBcImFkZExpc3RlbmVyXCIpICYmIF8uaXNGdW5jdGlvbihzcGVjcy5hZGRMaXN0ZW5lciksIFwiUi5FdmVudEVtaXR0ZXIuY3JlYXRlRXZlbnRFbWl0dGVyKC4uLik6IHJlcXVpcmVzIGFkZExpc3RlbmVyKFN0cmluZywgRnVuY3Rpb24pOiBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lci5cIik7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnQoXy5oYXMoc3BlY3MsIFwicmVtb3ZlTGlzdGVuZXJcIikgJiYgXy5pc0Z1bmN0aW9uKHNwZWNzLnJlbW92ZUxpc3RlbmVyKSwgXCJSLkV2ZW50RW1pdHRlci5jcmVhdGVFdmVudEVtaXR0ZXIoLi4uKVwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIC8qKlxyXG4gICAgICAgICAgICAgKiBAbWVtYmVyT2YgUi5FdmVudEVtaXR0ZXJcclxuICAgICAgICAgICAgICogQHB1YmxpY1xyXG4gICAgICAgICAgICAgKi9cclxuICAgICAgICAgICAgdmFyIEV2ZW50RW1pdHRlckluc3RhbmNlID0gZnVuY3Rpb24gRXZlbnRFbWl0dGVySW5zdGFuY2UoKSB7fTtcclxuICAgICAgICAgICAgXy5leHRlbmQoRXZlbnRFbWl0dGVySW5zdGFuY2UucHJvdG90eXBlLCBzcGVjcywge1xyXG4gICAgICAgICAgICAgICAgLyoqXHJcbiAgICAgICAgICAgICAgICAgKiAgVHlwZSBkaXJ0eS1jaGVja2luZy5cclxuICAgICAgICAgICAgICAgICAqICBAcHJpdmF0ZVxyXG4gICAgICAgICAgICAgICAgICogIEByZWFkT25seVxyXG4gICAgICAgICAgICAgICAgICovXHJcbiAgICAgICAgICAgICAgICBfaXNFdmVudEVtaXR0ZXJJbnN0YW5jZV86IHRydWUsXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gRXZlbnRFbWl0dGVySW5zdGFuY2U7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBMaXN0ZW5lcjogZnVuY3Rpb24gTGlzdGVuZXIoZXZlbnQpIHtcclxuICAgICAgICAgICAgdGhpcy51bmlxdWVJZCA9IF8udW5pcXVlSWQoXCJSLkV2ZW50RW1pdHRlci5MaXN0ZW5lclwiKTtcclxuICAgICAgICAgICAgdGhpcy5ldmVudCA9IGV2ZW50O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgKiA8cD4gUmV0dXJucyBhIG5ldyBNZW1vcnlFdmVudEVtaXR0ZXIgdGhhdCByZXByZXNlbnRzIGEgbWVtb3J5LWxvY2FsIHN0b3JlLCBlZy4gY2xpY2tzLCB3aW5kb3cgZXZlbnRzLjwvcD5cclxuICAgICAgICAqIEBtZXRob2QgY3JlYXRlTWVtb3J5RXZlbnRFbWl0dGVyXHJcbiAgICAgICAgKiBAcmV0dXJuIHtvYmplY3R9IE1lbW9yeUV2ZW50RW1pdHRlciBUaGUgY3JlYXRlZCBNZW1vcnlFdmVudEVtaXR0ZXIgaW5zdGFuY2VcclxuICAgICAgICAqL1xyXG4gICAgICAgIGNyZWF0ZU1lbW9yeUV2ZW50RW1pdHRlcjogZnVuY3Rpb24gY3JlYXRlTWVtb3J5RXZlbnRFbWl0dGVyKCkge1xyXG4gICAgICAgICAgICByZXR1cm4gZnVuY3Rpb24gTWVtb3J5RXZlbnRFbWl0dGVyKCkge1xyXG4gICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVycyA9IHt9O1xyXG4gICAgICAgICAgICAgICAgdmFyIGFkZExpc3RlbmVyID0gZnVuY3Rpb24gYWRkTGlzdGVuZXIoZXZlbnQsIGZuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgdmFyIGxpc3RlbmVyID0gbmV3IFIuRXZlbnRFbWl0dGVyLkxpc3RlbmVyKGV2ZW50KTtcclxuICAgICAgICAgICAgICAgICAgICBpZighXy5oYXMobGlzdGVuZXJzLCBldmVudCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2V2ZW50XSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyLnVuaXF1ZUlkXSA9IGZuO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcikge1xyXG4gICAgICAgICAgICAgICAgICAgIFIuRGVidWcuZGV2KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQobGlzdGVuZXIgaW5zdGFuY2VvZiBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lciwgXCJSLkV2ZW50RW1pdHRlci5NZW1vcnlFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogdHlwZSBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lciBleHBlY3RlZC5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmhhcyhsaXN0ZW5lcnMsIGxpc3RlbmVyLmV2ZW50KSwgXCJSLkV2ZW50RW1pdHRlci5NZW1vcnlFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogbm8gbGlzdGVuZXJzIGZvciB0aGlzIGV2ZW50LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KF8uaGFzKGxpc3RlbmVyc1tsaXN0ZW5lci5ldmVudF0sIGxpc3RlbmVyLnVuaXF1ZUlkKSwgXCJSLkV2ZW50RW1pdHRlci5NZW1vcnlFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogbm8gc3VjaCBsaXN0ZW5lci5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGxpc3RlbmVyc1tsaXN0ZW5lci5ldmVudF1bbGlzdGVuZXIudW5pcXVlSWRdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKF8uc2l6ZShsaXN0ZW5lcnNbbGlzdGVuZXIuZXZlbnRdKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgbGlzdGVuZXJzW2xpc3RlbmVyLmV2ZW50XTtcclxuICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgdmFyIGVtaXQgPSBmdW5jdGlvbiBlbWl0KGV2ZW50LCBwYXJhbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICBwYXJhbXMgPSBwYXJhbXMgfHwge307XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoXy5oYXMobGlzdGVuZXJzLCBldmVudCkpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgXy5lYWNoKGxpc3RlbmVyc1tldmVudF0sIGZ1bmN0aW9uKGZuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBpZihmbikge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGZuKHBhcmFtcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IChSLkV2ZW50RW1pdHRlci5jcmVhdGVFdmVudEVtaXR0ZXIoe1xyXG4gICAgICAgICAgICAgICAgICAgIGRpc3BsYXlOYW1lOiBcIk1lbW9yeUV2ZW50RW1pdHRlclwiLFxyXG4gICAgICAgICAgICAgICAgICAgIGFkZExpc3RlbmVyOiBhZGRMaXN0ZW5lcixcclxuICAgICAgICAgICAgICAgICAgICByZW1vdmVMaXN0ZW5lcjogcmVtb3ZlTGlzdGVuZXIsXHJcbiAgICAgICAgICAgICAgICAgICAgZW1pdDogZW1pdCxcclxuICAgICAgICAgICAgICAgIH0pKSgpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgLyoqXHJcbiAgICAgICAgKiA8cD4gUmV0dXJucyBhIG5ldyBVcGxpbmtFdmVudEVtaXR0ZXIgdGhhdCByZXByZXNlbnRzIGEgcmVtb3RlIGV2ZW50IGVtbWl0ZXIsIGVnLiBnbG9iYWwgbm90aWZpY2F0aW9ucywgYnJvYWRjYXN0cy4gPC9wPlxyXG4gICAgICAgICogQG1ldGhvZCBjcmVhdGVVcGxpbmtFdmVudEVtaXR0ZXJcclxuICAgICAgICAqIEByZXR1cm4ge29iamVjdH0gVXBsaW5rRXZlbnRFbWl0dGVyIFRoZSBjcmVhdGVkIFVwbGlua0V2ZW50RW1pdHRlciBpbnN0YW5jZVxyXG4gICAgICAgICovXHJcbiAgICAgICAgY3JlYXRlVXBsaW5rRXZlbnRFbWl0dGVyOiBmdW5jdGlvbiBjcmVhdGVVcGxpbmtFdmVudEVtaXR0ZXIoKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBmdW5jdGlvbiBVcGxpbmtFdmVudEVtaXR0ZXIodXBsaW5rKSB7XHJcbiAgICAgICAgICAgICAgICBSLkRlYnVnLmRldihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICBhc3NlcnQodXBsaW5rLmxpc3RlblRvICYmIF8uaXNGdW5jdGlvbih1cGxpbmsubGlzdGVuVG8pLCBcIlIuRXZlbnRFbWl0dGVyLmNyZWF0ZVVwbGlua0V2ZW50RW1pdHRlciguLi4pLnVwbGluay5saXN0ZW5UbzogZXhwZWN0aW5nIEZ1bmN0aW9uLlwiKTtcclxuICAgICAgICAgICAgICAgICAgICBhc3NlcnQodXBsaW5rLnVubGlzdGVuRnJvbSAmJiBfLmlzRnVuY3Rpb24odXBsaW5rLnVubGlzdGVuRnJvbSksIFwiUi5FdmVudEVtaXR0ZXIuY3JlYXRlVXBsaW5rRXZlbnRFbWl0dGVyKC4uLikudXBsaW5rLnVubGlzdGVuRnJvbTogZXhwZWN0aW5nIEZ1bmN0aW9uLlwiKTtcclxuICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgdmFyIGxpc3RlblRvID0gdXBsaW5rLmxpc3RlblRvO1xyXG4gICAgICAgICAgICAgICAgdmFyIHVubGlzdGVuRnJvbSA9IHVwbGluay51bmxpc3RlbkZyb207XHJcbiAgICAgICAgICAgICAgICB2YXIgbGlzdGVuZXJzID0ge307XHJcbiAgICAgICAgICAgICAgICB2YXIgZW1pdHRlcnMgPSB7fTtcclxuICAgICAgICAgICAgICAgIHZhciBhZGRMaXN0ZW5lciA9IGZ1bmN0aW9uIGFkZExpc3RlbmVyKGV2ZW50LCBmbikge1xyXG4gICAgICAgICAgICAgICAgICAgIHZhciBsaXN0ZW5lciA9IG5ldyBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lcihldmVudCk7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYoIV8uaGFzKGxpc3RlbmVycywgZXZlbnQpKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGVtaXR0ZXJzW2V2ZW50XSA9IGxpc3RlblRvKGV2ZW50LCBfLnBhcnRpYWwoZW1pdCwgZXZlbnQpKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgbGlzdGVuZXJzW2V2ZW50XSA9IHt9O1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBsaXN0ZW5lcnNbZXZlbnRdW2xpc3RlbmVyLnVuaXF1ZUlkXSA9IGZuO1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBsaXN0ZW5lcjtcclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB2YXIgcmVtb3ZlTGlzdGVuZXIgPSBmdW5jdGlvbiByZW1vdmVMaXN0ZW5lcihsaXN0ZW5lcikge1xyXG4gICAgICAgICAgICAgICAgICAgIFIuRGVidWcuZGV2KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBhc3NlcnQobGlzdGVuZXIgaW5zdGFuY2VvZiBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lciwgXCJSLkV2ZW50RW1pdHRlci5VcGxpbmtFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogdHlwZSBSLkV2ZW50RW1pdHRlci5MaXN0ZW5lciBleHBlY3RlZC5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydChfLmhhcyhsaXN0ZW5lcnMsIGxpc3RlbmVyLmV2ZW50KSwgXCJSLkV2ZW50RW1pdHRlci5VcGxpbmtFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogbm8gbGlzdGVuZXJzIGZvciB0aGlzIGV2ZW50LlwiKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KF8uaGFzKGxpc3RlbmVyc1tsaXN0ZW5lci5ldmVudF0sIGxpc3RlbmVyLnVuaXF1ZUlkKSwgXCJSLkV2ZW50RW1pdHRlci5VcGxpbmtFdmVudEVtaXR0ZXIucmVtb3ZlTGlzdGVuZXIoLi4uKTogbm8gc3VjaCBsaXN0ZW5lci5cIik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgZGVsZXRlIGxpc3RlbmVyc1tsaXN0ZW5lci5ldmVudF1bbGlzdGVuZXIudW5pcXVlSWRdO1xyXG4gICAgICAgICAgICAgICAgICAgIGlmKF8uc2l6ZShsaXN0ZW5lcnNbbGlzdGVuZXIuZXZlbnRdKSA9PT0gMCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB1bmxpc3RlbkZyb20obGlzdGVuZXIuZXZlbnQsIGVtaXR0ZXJzW2V2ZW50XSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGRlbGV0ZSBsaXN0ZW5lcnNbbGlzdGVuZXIuZXZlbnRdO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBkZWxldGUgZW1pdHRlcnNbbGlzdGVuZXIuZXZlbnRdO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgIH07XHJcbiAgICAgICAgICAgICAgICB2YXIgZW1pdCA9IGZ1bmN0aW9uIGVtaXQoZXZlbnQsIHBhcmFtcykge1xyXG4gICAgICAgICAgICAgICAgICAgIHBhcmFtcyA9IHBhcmFtcyB8fCB7fTtcclxuICAgICAgICAgICAgICAgICAgICBpZihfLmhhcyhsaXN0ZW5lcnMsIGV2ZW50KSkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICBfLmVhY2gobGlzdGVuZXJzW2V2ZW50XSwgZnVuY3Rpb24oZm4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGlmKGZuKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgZm4ocGFyYW1zKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfTtcclxuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgKFIuRXZlbnRFbWl0dGVyLmNyZWF0ZUV2ZW50RW1pdHRlcih7XHJcbiAgICAgICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IFwiVXBsaW5rRXZlbnRFbWl0dGVyXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgYWRkTGlzdGVuZXI6IGFkZExpc3RlbmVyLFxyXG4gICAgICAgICAgICAgICAgICAgIHJlbW92ZUxpc3RlbmVyOiByZW1vdmVMaXN0ZW5lcixcclxuICAgICAgICAgICAgICAgIH0pKSgpO1xyXG4gICAgICAgICAgICB9O1xyXG4gICAgICAgIH0sXHJcbiAgICB9O1xyXG5cclxuICAgIF8uZXh0ZW5kKEV2ZW50RW1pdHRlci5MaXN0ZW5lci5wcm90b3R5cGUsIC8qKiBAbGVuZHMgUi5FdmVudEVtaXR0ZXIuTGlzdGVuZXIucHJvdG90eXBlICovIHtcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJvcGVydHkgdW5pcXVlSWRcclxuICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfVxyXG4gICAgICAgICAqIEBwdWJsaWNcclxuICAgICAgICAgKiBAcmVhZE9ubHlcclxuICAgICAgICAgKi9cclxuICAgICAgICB1bmlxdWVJZDogbnVsbCxcclxuICAgICAgICAvKipcclxuICAgICAgICAgKiBAcHJvcGVydHkgZXZlbnRcclxuICAgICAgICAgKiBAdHlwZSB7U3RyaW5nfVxyXG4gICAgICAgICAqIEBwdWJsaWNcclxuICAgICAgICAgKiBAcmVhZE9ubHlcclxuICAgICAgICAgKi9cclxuICAgICAgICBldmVudDogbnVsbCxcclxuICAgIH0pO1xyXG5cclxuICAgIHJldHVybiBFdmVudEVtaXR0ZXI7XHJcbn07XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==