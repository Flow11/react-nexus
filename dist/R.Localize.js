"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
module.exports = function (R) {
  var _ = require("lodash");
  var assert = require("assert");
  var Locales = require("locale").Locales;
  var React = R.React;

  var Localize = {
    extractLocale: function extractLocale(headers, supported) {
      R.Debug.dev(function () {
        assert(_.has(headers, "accept-language") && _.isString(headers["accept-language"]), "R.Localize.extractLocale(...).headers['accept-language']: expected String.");
      });
      var supportedLocales = new Locales(supported);
      var acceptedLocales = new Locales(headers["accept-language"]);
      return acceptedLocales.best(supportedLocales);
    },
    createPlugin: function createPlugin(storeName, dispatcherName, supportedLocales) {
      return R.App.createPlugin({
        displayName: "Localize",
        installInClient: function installInClient(flux, window) {
          flux.getDispatcher(dispatcherName).addActionListener("/Localize/setLocale", regeneratorRuntime.mark(function setLocale(params) {
            return regeneratorRuntime.wrap(function setLocale$(context$4$0) {
              while (1) switch (context$4$0.prev = context$4$0.next) {case 0:

                  R.Debug.dev(function () {
                    assert(params.locale && _.isString(params.locale), dispatcherName + "://Localize/setLocale.params.locale: expected String.");
                  });
                  context$4$0.next = 3;
                  return _.defer;

                case 3: flux.getStore(storeName).set("/Localize/locale", Localize.extractLocale(params.locale, supportedLocales));
                case 4:
                case "end": return context$4$0.stop();
              }
            }, setLocale, this);
          }));
        },
        installInServer: function installInServer(flux, req) {
          flux.getStore(storeName).set("/Localize/locale", Localize.extractLocale(req.headers, supportedLocales));
        } });
    },
    createLocalizeClass: function createClass(specs) {
      R.Debug.dev(function () {
        assert(specs.storeName && _.isString(specs.storeName), "R.Localize.createClass(...).specs.storeName: expected String.");
        assert(specs.dispatcherName && _.isString(specs.dispatcherName), "R.Localize.createClass(...).specs.dispatcherName: expected String.");
      });
      return React.createClass({
        propTypes: {
          locale: React.propTypes.string.isRequired,
          children: React.PropTypes.element.isRequired },
        getInitialState: function getInitialState() {
          return {
            locale: null };
        },
        getFluxStoreSubscriptions: function getFluxStoreSubscriptions(props) {
          return R.record(specs.storeName + "://Localize/locale", "locale");
        },
        render: function render() {
          if (this.props.locale === this.state.locale) {
            return React.Children.only(this.props.children);
          } else {
            return null;
          }
        } });
    } };

  return Localize;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImQ6L3dvcmtzcGFjZV9yZWZhY3Rvci9yZWFjdC1yYWlscy9zcmMvUi5Mb2NhbGl6ZS5qcyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLE9BQU8sQ0FBQyxlQUFlLENBQUMsQ0FBQztBQUN6QixJQUFNLE9BQU8sR0FBRyxPQUFPLENBQUMsVUFBVSxDQUFDLENBQUM7QUFDcEMsTUFBTSxDQUFDLE9BQU8sR0FBRyxVQUFTLENBQUMsRUFBRTtBQUN6QixNQUFJLENBQUMsR0FBRyxPQUFPLENBQUMsUUFBUSxDQUFDLENBQUM7QUFDMUIsTUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLE1BQUksT0FBTyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQyxPQUFPLENBQUM7QUFDeEMsTUFBSSxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQzs7QUFFcEIsTUFBSSxRQUFRLEdBQUc7QUFDWCxpQkFBYSxFQUFFLFNBQVMsYUFBYSxDQUFDLE9BQU8sRUFBRSxTQUFTLEVBQUU7QUFDdEQsT0FBQyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsWUFBVztBQUNuQixjQUFNLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsaUJBQWlCLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLEVBQUUsNEVBQTRFLENBQUMsQ0FBQztPQUNySyxDQUFDLENBQUM7QUFDSCxVQUFJLGdCQUFnQixHQUFHLElBQUksT0FBTyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBQzlDLFVBQUksZUFBZSxHQUFHLElBQUksT0FBTyxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxDQUFDLENBQUM7QUFDOUQsYUFBTyxlQUFlLENBQUMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLENBQUM7S0FDakQ7QUFDRCxnQkFBWSxFQUFFLFNBQVMsWUFBWSxDQUFDLFNBQVMsRUFBRSxjQUFjLEVBQUUsZ0JBQWdCLEVBQUU7QUFDN0UsYUFBTyxDQUFDLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztBQUN0QixtQkFBVyxFQUFFLFVBQVU7QUFDdkIsdUJBQWUsRUFBRSxTQUFTLGVBQWUsQ0FBQyxJQUFJLEVBQUUsTUFBTSxFQUFFO0FBQ3BELGNBQUksQ0FBQyxhQUFhLENBQUMsY0FBYyxDQUFDLENBQUMsaUJBQWlCLENBQUMscUJBQXFCLDBCQUFFLFNBQVUsU0FBUyxDQUFDLE1BQU07Ozs7QUFDbEcsbUJBQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVc7QUFDbkIsMEJBQU0sQ0FBQyxNQUFNLENBQUMsTUFBTSxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxFQUFFLGNBQWMsR0FBRyx1REFBdUQsQ0FBQyxDQUFDO21CQUNoSSxDQUFDLENBQUM7O3lCQUNHLENBQUMsQ0FBQyxLQUFLOzt3QkFDYixJQUFJLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxrQkFBa0IsRUFBRSxRQUFRLENBQUMsYUFBYSxDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsZ0JBQWdCLENBQUMsQ0FBQyxDQUFDOzs7O2VBTHhCLFNBQVM7V0FNOUYsRUFBQyxDQUFDO1NBQ047QUFDRCx1QkFBZSxFQUFFLFNBQVMsZUFBZSxDQUFDLElBQUksRUFBRSxHQUFHLEVBQUU7QUFDakQsY0FBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEVBQUUsUUFBUSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsT0FBTyxFQUFFLGdCQUFnQixDQUFDLENBQUMsQ0FBQztTQUMzRyxFQUNKLENBQUMsQ0FBQztLQUNOO0FBQ0QsdUJBQW1CLEVBQUUsU0FBUyxXQUFXLENBQUMsS0FBSyxFQUFFO0FBQzdDLE9BQUMsQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVc7QUFDbkIsY0FBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLElBQUksQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsU0FBUyxDQUFDLEVBQUUsK0RBQStELENBQUMsQ0FBQztBQUN4SCxjQUFNLENBQUMsS0FBSyxDQUFDLGNBQWMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxjQUFjLENBQUMsRUFBRSxvRUFBb0UsQ0FBQyxDQUFDO09BQzFJLENBQUMsQ0FBQztBQUNILGFBQU8sS0FBSyxDQUFDLFdBQVcsQ0FBQztBQUNyQixpQkFBUyxFQUFFO0FBQ1AsZ0JBQU0sRUFBRSxLQUFLLENBQUMsU0FBUyxDQUFDLE1BQU0sQ0FBQyxVQUFVO0FBQ3pDLGtCQUFRLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxPQUFPLENBQUMsVUFBVSxFQUMvQztBQUNELHVCQUFlLEVBQUUsU0FBUyxlQUFlLEdBQUc7QUFDeEMsaUJBQU87QUFDSCxrQkFBTSxFQUFFLElBQUksRUFDZixDQUFDO1NBQ0w7QUFDRCxpQ0FBeUIsRUFBRSxTQUFTLHlCQUF5QixDQUFDLEtBQUssRUFBRTtBQUNqRSxpQkFBTyxDQUFDLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxTQUFTLEdBQUcsb0JBQW9CLEVBQUUsUUFBUSxDQUFDLENBQUM7U0FDckU7QUFDRCxjQUFNLEVBQUUsU0FBUyxNQUFNLEdBQUc7QUFDdEIsY0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sS0FBSyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRTtBQUN4QyxtQkFBTyxLQUFLLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1dBQ25ELE1BQ0k7QUFDRCxtQkFBTyxJQUFJLENBQUM7V0FDZjtTQUNKLEVBQ0osQ0FBQyxDQUFDO0tBQ04sRUFDSixDQUFDOztBQUVGLFNBQU8sUUFBUSxDQUFDO0NBQ25CLENBQUMiLCJmaWxlIjoiUi5Mb2NhbGl6ZS5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJzZ0bzUvcG9seWZpbGwnKTtcbmNvbnN0IFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihSKSB7XHJcbiAgICB2YXIgXyA9IHJlcXVpcmUoXCJsb2Rhc2hcIik7XHJcbiAgICB2YXIgYXNzZXJ0ID0gcmVxdWlyZShcImFzc2VydFwiKTtcclxuICAgIHZhciBMb2NhbGVzID0gcmVxdWlyZShcImxvY2FsZVwiKS5Mb2NhbGVzO1xyXG4gICAgdmFyIFJlYWN0ID0gUi5SZWFjdDtcclxuXHJcbiAgICB2YXIgTG9jYWxpemUgPSB7XHJcbiAgICAgICAgZXh0cmFjdExvY2FsZTogZnVuY3Rpb24gZXh0cmFjdExvY2FsZShoZWFkZXJzLCBzdXBwb3J0ZWQpIHtcclxuICAgICAgICAgICAgUi5EZWJ1Zy5kZXYoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnQoXy5oYXMoaGVhZGVycywgXCJhY2NlcHQtbGFuZ3VhZ2VcIikgJiYgXy5pc1N0cmluZyhoZWFkZXJzW1wiYWNjZXB0LWxhbmd1YWdlXCJdKSwgXCJSLkxvY2FsaXplLmV4dHJhY3RMb2NhbGUoLi4uKS5oZWFkZXJzWydhY2NlcHQtbGFuZ3VhZ2UnXTogZXhwZWN0ZWQgU3RyaW5nLlwiKTtcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgIHZhciBzdXBwb3J0ZWRMb2NhbGVzID0gbmV3IExvY2FsZXMoc3VwcG9ydGVkKTtcclxuICAgICAgICAgICAgdmFyIGFjY2VwdGVkTG9jYWxlcyA9IG5ldyBMb2NhbGVzKGhlYWRlcnNbXCJhY2NlcHQtbGFuZ3VhZ2VcIl0pO1xyXG4gICAgICAgICAgICByZXR1cm4gYWNjZXB0ZWRMb2NhbGVzLmJlc3Qoc3VwcG9ydGVkTG9jYWxlcyk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjcmVhdGVQbHVnaW46IGZ1bmN0aW9uIGNyZWF0ZVBsdWdpbihzdG9yZU5hbWUsIGRpc3BhdGNoZXJOYW1lLCBzdXBwb3J0ZWRMb2NhbGVzKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBSLkFwcC5jcmVhdGVQbHVnaW4oe1xyXG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IFwiTG9jYWxpemVcIixcclxuICAgICAgICAgICAgICAgIGluc3RhbGxJbkNsaWVudDogZnVuY3Rpb24gaW5zdGFsbEluQ2xpZW50KGZsdXgsIHdpbmRvdykge1xyXG4gICAgICAgICAgICAgICAgICAgIGZsdXguZ2V0RGlzcGF0Y2hlcihkaXNwYXRjaGVyTmFtZSkuYWRkQWN0aW9uTGlzdGVuZXIoXCIvTG9jYWxpemUvc2V0TG9jYWxlXCIsIGZ1bmN0aW9uKiBzZXRMb2NhbGUocGFyYW1zKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIFIuRGVidWcuZGV2KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgYXNzZXJ0KHBhcmFtcy5sb2NhbGUgJiYgXy5pc1N0cmluZyhwYXJhbXMubG9jYWxlKSwgZGlzcGF0Y2hlck5hbWUgKyBcIjovL0xvY2FsaXplL3NldExvY2FsZS5wYXJhbXMubG9jYWxlOiBleHBlY3RlZCBTdHJpbmcuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgXy5kZWZlcjtcclxuICAgICAgICAgICAgICAgICAgICAgICAgZmx1eC5nZXRTdG9yZShzdG9yZU5hbWUpLnNldChcIi9Mb2NhbGl6ZS9sb2NhbGVcIiwgTG9jYWxpemUuZXh0cmFjdExvY2FsZShwYXJhbXMubG9jYWxlLCBzdXBwb3J0ZWRMb2NhbGVzKSk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgaW5zdGFsbEluU2VydmVyOiBmdW5jdGlvbiBpbnN0YWxsSW5TZXJ2ZXIoZmx1eCwgcmVxKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgZmx1eC5nZXRTdG9yZShzdG9yZU5hbWUpLnNldChcIi9Mb2NhbGl6ZS9sb2NhbGVcIiwgTG9jYWxpemUuZXh0cmFjdExvY2FsZShyZXEuaGVhZGVycywgc3VwcG9ydGVkTG9jYWxlcykpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgICAgICBjcmVhdGVMb2NhbGl6ZUNsYXNzOiBmdW5jdGlvbiBjcmVhdGVDbGFzcyhzcGVjcykge1xyXG4gICAgICAgICAgICBSLkRlYnVnLmRldihmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgIGFzc2VydChzcGVjcy5zdG9yZU5hbWUgJiYgXy5pc1N0cmluZyhzcGVjcy5zdG9yZU5hbWUpLCBcIlIuTG9jYWxpemUuY3JlYXRlQ2xhc3MoLi4uKS5zcGVjcy5zdG9yZU5hbWU6IGV4cGVjdGVkIFN0cmluZy5cIik7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnQoc3BlY3MuZGlzcGF0Y2hlck5hbWUgJiYgXy5pc1N0cmluZyhzcGVjcy5kaXNwYXRjaGVyTmFtZSksIFwiUi5Mb2NhbGl6ZS5jcmVhdGVDbGFzcyguLi4pLnNwZWNzLmRpc3BhdGNoZXJOYW1lOiBleHBlY3RlZCBTdHJpbmcuXCIpO1xyXG4gICAgICAgICAgICB9KTtcclxuICAgICAgICAgICAgcmV0dXJuIFJlYWN0LmNyZWF0ZUNsYXNzKHtcclxuICAgICAgICAgICAgICAgIHByb3BUeXBlczoge1xyXG4gICAgICAgICAgICAgICAgICAgIGxvY2FsZTogUmVhY3QucHJvcFR5cGVzLnN0cmluZy5pc1JlcXVpcmVkLFxyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBSZWFjdC5Qcm9wVHlwZXMuZWxlbWVudC5pc1JlcXVpcmVkLFxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGdldEluaXRpYWxTdGF0ZTogZnVuY3Rpb24gZ2V0SW5pdGlhbFN0YXRlKCkge1xyXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGxvY2FsZTogbnVsbCxcclxuICAgICAgICAgICAgICAgICAgICB9O1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGdldEZsdXhTdG9yZVN1YnNjcmlwdGlvbnM6IGZ1bmN0aW9uIGdldEZsdXhTdG9yZVN1YnNjcmlwdGlvbnMocHJvcHMpIHtcclxuICAgICAgICAgICAgICAgICAgICByZXR1cm4gUi5yZWNvcmQoc3BlY3Muc3RvcmVOYW1lICsgXCI6Ly9Mb2NhbGl6ZS9sb2NhbGVcIiwgXCJsb2NhbGVcIik7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgaWYodGhpcy5wcm9wcy5sb2NhbGUgPT09IHRoaXMuc3RhdGUubG9jYWxlKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgIHJldHVybiBSZWFjdC5DaGlsZHJlbi5vbmx5KHRoaXMucHJvcHMuY2hpbGRyZW4pO1xyXG4gICAgICAgICAgICAgICAgICAgIH1cclxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIG51bGw7XHJcbiAgICAgICAgICAgICAgICAgICAgfVxyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIExvY2FsaXplO1xyXG59O1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=