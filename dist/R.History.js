"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
module.exports = function (R) {
  var url = require("url");
  var co = require("co");
  var assert = require("assert");
  var _ = require("lodash");
  var React = R.React;

  var History = {
    createPlugin: function createPlugin(storeName, dispatcherName) {
      return R.App.createPlugin({
        displayName: "History",
        updateStoreToHref: function updateStoreToHref(flux, href) {
          flux.getStore(storeName).set("/History/pathname", url.parse(href).pathname);
        },
        installInClient: function installInClient(flux, window) {
          flux.getDispatcher(dispatcherName).addActionListener("/History/navigate", R.scope(function navigate(params) {
            return R.scope(function (fn) {
              R.Debug.dev(function () {
                assert(params.pathname && _.isString(params.pathname), "/History/navigate: params.pathname: expecting String.");
              });
              var href = url.format(_.extend(url.parse(window.location.href), { pathname: params.pathname }));
              window.history.pushState(null, null, href);
              this.updateStoreToHref(flux, href);
              _.defer(fn);
            }, this);
          }, this));
          window.addEventListener("popstate", R.scope(function () {
            this.updateStoreToHref(flux, window.location.href);
          }, this));
          this.updateStoreToHref(flux, window.location.href);
        },
        installInServer: function installInServer(flux, req) {
          this.updateStoreToHref(flux, url.parse(req.url).pathname);
        } });
    },
    createLinkClass: function createLinkClass(specs) {
      R.Debug.dev(function () {
        assert(specs.dispatcherName && _.isString(specs.dispatcherName), "R.History.createClass(...).specs.dispatcherName: expected String.");
      });
      return React.createClass({
        displayName: "HistoryLink",
        mixins: [R.Component.Mixin],
        propTypes: {
          children: React.PropTypes.any.isRequired,
          pathname: React.PropTypes.string.isRequired },
        handleClick: function handleClick(event) {
          event.preventDefault();
          co(regeneratorRuntime.mark(function callee$3$0() {
            return regeneratorRuntime.wrap(function callee$3$0$(context$4$0) {
              while (1) switch (context$4$0.prev = context$4$0.next) {case 0:
                  context$4$0.next = 2;
                  return this.getFluxDispatcher(specs.dispatcherName).dispatch("/History/navigate", { pathname: this.props.pathname });

                case 2:
                case "end": return context$4$0.stop();
              }
            }, callee$3$0, this);
          })).call(this);
        },
        render: function render() {
          return React.DOM.a({
            className: "HistoryLink",
            href: this.props.pathname,
            onClick: this.handleClick,
            children: this.props.children });
        } });
    } };

  return History;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImQ6L3dvcmtzcGFjZV9yZWZhY3Rvci9yZWFjdC1yYWlscy9zcmMvUi5IaXN0b3J5LmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNwQyxNQUFNLENBQUMsT0FBTyxHQUFHLFVBQVMsQ0FBQyxFQUFFO0FBQ3pCLE1BQUksR0FBRyxHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQztBQUN6QixNQUFJLEVBQUUsR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUM7QUFDdkIsTUFBSSxNQUFNLEdBQUcsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0FBQy9CLE1BQUksQ0FBQyxHQUFHLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQztBQUMxQixNQUFJLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDOztBQUVwQixNQUFJLE9BQU8sR0FBRztBQUNWLGdCQUFZLEVBQUUsU0FBUyxZQUFZLENBQUMsU0FBUyxFQUFFLGNBQWMsRUFBRTtBQUMzRCxhQUFPLENBQUMsQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO0FBQ3RCLG1CQUFXLEVBQUUsU0FBUztBQUN0Qix5QkFBaUIsRUFBRSxTQUFTLGlCQUFpQixDQUFDLElBQUksRUFBRSxJQUFJLEVBQUU7QUFDdEQsY0FBSSxDQUFDLFFBQVEsQ0FBQyxTQUFTLENBQUMsQ0FBQyxHQUFHLENBQUMsbUJBQW1CLEVBQUUsR0FBRyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQyxRQUFRLENBQUMsQ0FBQztTQUMvRTtBQUNELHVCQUFlLEVBQUUsU0FBUyxlQUFlLENBQUMsSUFBSSxFQUFFLE1BQU0sRUFBRTtBQUNwRCxjQUFJLENBQUMsYUFBYSxDQUFDLGNBQWMsQ0FBQyxDQUFDLGlCQUFpQixDQUFDLG1CQUFtQixFQUFFLENBQUMsQ0FBQyxLQUFLLENBQUMsU0FBUyxRQUFR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QkFBUyxFQUFFLGFBQWE7QUFDeEIsZ0JBQUksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLFFBQVE7QUFDekIsbUJBQU8sRUFBRSxJQUFJLENBQUMsV0FBVztBQUN6QixvQkFBUSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsUUFBUSxFQUNoQyxDQUFDLENBQUM7U0FDTixFQUNKLENBQUMsQ0FBQztLQUNOLEVBQ0osQ0FBQzs7QUFFRixTQUFPLE9BQU8sQ0FBQztDQUNsQixDQUFDIiwiZmlsZSI6IlIuSGlzdG9yeS5qcyIsInNvdXJjZXNDb250ZW50IjpbInJlcXVpcmUoJzZ0bzUvcG9seWZpbGwnKTtcbmNvbnN0IFByb21pc2UgPSByZXF1aXJlKCdibHVlYmlyZCcpO1xubW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbihSKSB7XHJcbiAgICB2YXIgdXJsID0gcmVxdWlyZShcInVybFwiKTtcclxuICAgIHZhciBjbyA9IHJlcXVpcmUoXCJjb1wiKTtcclxuICAgIHZhciBhc3NlcnQgPSByZXF1aXJlKFwiYXNzZXJ0XCIpO1xyXG4gICAgdmFyIF8gPSByZXF1aXJlKFwibG9kYXNoXCIpO1xyXG4gICAgdmFyIFJlYWN0ID0gUi5SZWFjdDtcclxuXHJcbiAgICB2YXIgSGlzdG9yeSA9IHtcclxuICAgICAgICBjcmVhdGVQbHVnaW46IGZ1bmN0aW9uIGNyZWF0ZVBsdWdpbihzdG9yZU5hbWUsIGRpc3BhdGNoZXJOYW1lKSB7XHJcbiAgICAgICAgICAgIHJldHVybiBSLkFwcC5jcmVhdGVQbHVnaW4oe1xyXG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IFwiSGlzdG9yeVwiLFxyXG4gICAgICAgICAgICAgICAgdXBkYXRlU3RvcmVUb0hyZWY6IGZ1bmN0aW9uIHVwZGF0ZVN0b3JlVG9IcmVmKGZsdXgsIGhyZWYpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbHV4LmdldFN0b3JlKHN0b3JlTmFtZSkuc2V0KFwiL0hpc3RvcnkvcGF0aG5hbWVcIiwgdXJsLnBhcnNlKGhyZWYpLnBhdGhuYW1lKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBpbnN0YWxsSW5DbGllbnQ6IGZ1bmN0aW9uIGluc3RhbGxJbkNsaWVudChmbHV4LCB3aW5kb3cpIHtcclxuICAgICAgICAgICAgICAgICAgICBmbHV4LmdldERpc3BhdGNoZXIoZGlzcGF0Y2hlck5hbWUpLmFkZEFjdGlvbkxpc3RlbmVyKFwiL0hpc3RvcnkvbmF2aWdhdGVcIiwgUi5zY29wZShmdW5jdGlvbiBuYXZpZ2F0ZShwYXJhbXMpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFIuc2NvcGUoZnVuY3Rpb24oZm4pIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIFIuRGVidWcuZGV2KGZ1bmN0aW9uKCkge1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGFzc2VydChwYXJhbXMucGF0aG5hbWUgJiYgXy5pc1N0cmluZyhwYXJhbXMucGF0aG5hbWUpLCBcIi9IaXN0b3J5L25hdmlnYXRlOiBwYXJhbXMucGF0aG5hbWU6IGV4cGVjdGluZyBTdHJpbmcuXCIpO1xyXG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB2YXIgaHJlZiA9IHVybC5mb3JtYXQoXy5leHRlbmQodXJsLnBhcnNlKHdpbmRvdy5sb2NhdGlvbi5ocmVmKSwgeyBwYXRobmFtZTogcGFyYW1zLnBhdGhuYW1lIH0pKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHdpbmRvdy5oaXN0b3J5LnB1c2hTdGF0ZShudWxsLCBudWxsLCBocmVmKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RvcmVUb0hyZWYoZmx1eCwgaHJlZik7XHJcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICBfLmRlZmVyKGZuKTtcclxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgdGhpcyk7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHdpbmRvdy5hZGRFdmVudExpc3RlbmVyKFwicG9wc3RhdGVcIiwgUi5zY29wZShmdW5jdGlvbigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy51cGRhdGVTdG9yZVRvSHJlZihmbHV4LCB3aW5kb3cubG9jYXRpb24uaHJlZik7XHJcbiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcykpO1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RvcmVUb0hyZWYoZmx1eCwgd2luZG93LmxvY2F0aW9uLmhyZWYpO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgICAgIGluc3RhbGxJblNlcnZlcjogZnVuY3Rpb24gaW5zdGFsbEluU2VydmVyKGZsdXgsIHJlcSkge1xyXG4gICAgICAgICAgICAgICAgICAgIHRoaXMudXBkYXRlU3RvcmVUb0hyZWYoZmx1eCwgdXJsLnBhcnNlKHJlcS51cmwpLnBhdGhuYW1lKTtcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgIH0sXHJcbiAgICAgICAgY3JlYXRlTGlua0NsYXNzOiBmdW5jdGlvbiBjcmVhdGVMaW5rQ2xhc3Moc3BlY3MpIHtcclxuICAgICAgICAgICAgUi5EZWJ1Zy5kZXYoZnVuY3Rpb24oKSB7XHJcbiAgICAgICAgICAgICAgICBhc3NlcnQoc3BlY3MuZGlzcGF0Y2hlck5hbWUgJiYgXy5pc1N0cmluZyhzcGVjcy5kaXNwYXRjaGVyTmFtZSksIFwiUi5IaXN0b3J5LmNyZWF0ZUNsYXNzKC4uLikuc3BlY3MuZGlzcGF0Y2hlck5hbWU6IGV4cGVjdGVkIFN0cmluZy5cIik7XHJcbiAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICByZXR1cm4gUmVhY3QuY3JlYXRlQ2xhc3Moe1xyXG4gICAgICAgICAgICAgICAgZGlzcGxheU5hbWU6IFwiSGlzdG9yeUxpbmtcIixcclxuICAgICAgICAgICAgICAgIG1peGluczogW1IuQ29tcG9uZW50Lk1peGluXSxcclxuICAgICAgICAgICAgICAgIHByb3BUeXBlczoge1xyXG4gICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiBSZWFjdC5Qcm9wVHlwZXMuYW55LmlzUmVxdWlyZWQsXHJcbiAgICAgICAgICAgICAgICAgICAgcGF0aG5hbWU6IFJlYWN0LlByb3BUeXBlcy5zdHJpbmcuaXNSZXF1aXJlZCxcclxuICAgICAgICAgICAgICAgIH0sXHJcbiAgICAgICAgICAgICAgICBoYW5kbGVDbGljazogZnVuY3Rpb24gaGFuZGxlQ2xpY2soZXZlbnQpIHtcclxuICAgICAgICAgICAgICAgICAgICBldmVudC5wcmV2ZW50RGVmYXVsdCgpO1xyXG4gICAgICAgICAgICAgICAgICAgIGNvKGZ1bmN0aW9uKigpIHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgeWllbGQgdGhpcy5nZXRGbHV4RGlzcGF0Y2hlcihzcGVjcy5kaXNwYXRjaGVyTmFtZSkuZGlzcGF0Y2goXCIvSGlzdG9yeS9uYXZpZ2F0ZVwiLCB7IHBhdGhuYW1lOiB0aGlzLnByb3BzLnBhdGhuYW1lIH0pO1xyXG4gICAgICAgICAgICAgICAgICAgIH0pLmNhbGwodGhpcyk7XHJcbiAgICAgICAgICAgICAgICB9LFxyXG4gICAgICAgICAgICAgICAgcmVuZGVyOiBmdW5jdGlvbiByZW5kZXIoKSB7XHJcbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIFJlYWN0LkRPTS5hKHtcclxuICAgICAgICAgICAgICAgICAgICAgICAgY2xhc3NOYW1lOiBcIkhpc3RvcnlMaW5rXCIsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGhyZWY6IHRoaXMucHJvcHMucGF0aG5hbWUsXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIG9uQ2xpY2s6IHRoaXMuaGFuZGxlQ2xpY2ssXHJcbiAgICAgICAgICAgICAgICAgICAgICAgIGNoaWxkcmVuOiB0aGlzLnByb3BzLmNoaWxkcmVuLFxyXG4gICAgICAgICAgICAgICAgICAgIH0pO1xyXG4gICAgICAgICAgICAgICAgfSxcclxuICAgICAgICAgICAgfSk7XHJcbiAgICAgICAgfSxcclxuICAgIH07XHJcblxyXG4gICAgcmV0dXJuIEhpc3Rvcnk7XHJcbn07XHJcbiJdLCJzb3VyY2VSb290IjoiL3NvdXJjZS8ifQ==