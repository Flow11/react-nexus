"use strict";

require("6to5/polyfill");
var Promise = require("bluebird");
module.exports = function (R) {
  var _ = R._;
  var requestAnimationFrame = require("raf");

  require("setimmediate");

  function clearAnimationFrame(handle) {
    requestAnimationFrame.cancel(handle);
  }

  var Async = {
    ifMounted: function (fn) {
      var _this = this;
      var _arguments = arguments;

      return function () {
        _.dev(function () {
          return _this._AsyncMixin.should.be.ok;
        });
        if (!_this._AsyncMixinHasUnmounted) {
          return fn.apply(_this, _arguments);
        }
      };
    },

    _deferredImmediate: function (fn) {
      var _this2 = this;
      var _arguments2 = arguments;

      return function () {
        var args = _arguments2;
        var id = _.uniqueId("setImmediate");
        var q = setImmediate(function () {
          delete _this2._AsyncMixinQueuedImmediates[id];
          return fn.apply(_this2, args);
        });
        _this2._AsyncMixinQueuedImmediates[id] = q;
        return id;
      };
    },

    _deferredAnimationFrame: function (fn) {
      var _this3 = this;
      var _arguments3 = arguments;

      return function () {
        var args = _arguments3;
        var id = _.uniqueId("setImmediate");
        var q = requestAnimationFrame(function () {
          delete _this3._AsyncMixinQueuedAnimationFrames[id];
          return fn.apply(_this3, args);
        });
        _this3._AsyncMixinQueuedAnimationFrames[id] = q;
        return id;
      };
    },

    _deferredTimeout: function (delay) {
      var _this4 = this;
      var _arguments4 = arguments;

      return function (fn) {
        return function () {
          var args = _arguments4;
          var id = _.uniqueId("setTimeout");
          var q = setTimeout(function () {
            delete _this4._AsyncMixinQueuedTimeouts[id];
            return fn.apply(_this4, args);
          }, delay);
          _this4._AsyncMixinQueuedTimeouts[id] = q;
          return q;
        };
      };
    },

    deferred: function (fn, delay) {
      var ifn = R.Async.ifMounted(fn);
      if (!delay) {
        return R.Async._deferredImmediate(ifn);
      } else {
        return R.Async._deferredTimeout(ifn, delay);
      }
    },

    deferredAnimationFrame: function (fn) {
      var ifn = R.Async.ifMounted(fn);
      return R.Async._deferredAnimationFrame(ifn);
    } };

  Async.Mixin = {
    _AsyncMixin: true,
    _AsyncMixinHasUnmounted: false,
    _AsyncMixinQueuedTimeouts: null,
    _AsyncMixinQueuedImmediates: null,
    _AsyncMixinQueuedAnimationFrames: null,

    componentWillMountcomponentWillMount: function () {
      this._AsyncMixinQueuedTimeouts = {};
      this._AsyncMixinQueuedImmediates = {};
      this._AsyncMixinQueuedAnimationFrames = {};
    },

    componentWillUnmount: function () {
      _.each(this._AsyncMixinQueuedTimeouts, clearTimeout);
      _.each(this._AsyncMixinQueuedImmediates, clearImmediate);
      _.each(this._AsyncMixinQueuedAnimationFrames, clearAnimationFrame);
      this._AsyncMixinHasUnmounted = true;
    },

    setStateIfMounted: Async.ifMounted(function (state) {
      this.setState(state);
    }) };

  return Async;
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImY6L1VzZXJzL0VsaWUvZ2l0L3JlYWN0L3JlYWN0LXJhaWxzL3NyYy9SLkFzeW5jLmpzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsT0FBTyxDQUFDLGVBQWUsQ0FBQyxDQUFDO0FBQ3pCLElBQU0sT0FBTyxHQUFHLE9BQU8sQ0FBQyxVQUFVLENBQUMsQ0FBQztBQUNwQyxNQUFNLENBQUMsT0FBTyxHQUFHLFVBQVMsQ0FBQyxFQUFFO0FBQzNCLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUM7QUFDZCxNQUFNLHFCQUFxQixHQUFHLE9BQU8sQ0FBQyxLQUFLLENBQUMsQ0FBQzs7QUFFN0MsU0FBTyxDQUFDLGNBQWMsQ0FBQyxDQUFDOztBQUV4QixXQUFTLG1CQUFtQixDQUFDLE1BQU0sRUFBRTtBQUNuQyx5QkFBcUIsQ0FBQyxNQUFNLENBQUMsTUFBTSxDQUFDLENBQUM7R0FDdEM7O0FBRUQsTUFBTSxLQUFLLEdBQUc7QUFDWixhQUFTLEVBQUEsVUFBQyxFQUFFLEVBQUU7Ozs7QUFDWixhQUFPLFlBQU07QUFDWCxTQUFDLENBQUMsR0FBRyxDQUFDO2lCQUFNLE1BQUssV0FBVyxDQUFDLE1BQU0sQ0FBQyxFQUFFLENBQUMsRUFBRTtTQUFBLENBQUMsQ0FBQztBQUMzQyxZQUFHLENBQUMsTUFBSyx1QkFBdUIsRUFBRTtBQUNoQyxpQkFBTyxFQUFFLENBQUMsS0FBSyxtQkFBaUIsQ0FBQztTQUNsQztPQUNGLENBQUM7S0FDSDs7QUFFRCxzQkFBa0IsRUFBQSxVQUFDLEVBQUUsRUFBRTs7OztBQUNyQixhQUFPLFlBQU07QUFDWCxZQUFJLElBQUksY0FBWSxDQUFDO0FBQ3JCLFlBQUksRUFBRSxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsY0FBYyxDQUFDLENBQUM7QUFDcEMsWUFBSSxDQUFDLEdBQUcsWUFBWSxDQUFDLFlBQU07QUFDekIsaUJBQU8sT0FBSywyQkFBMkIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUM1QyxpQkFBTyxFQUFF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QyxnQ0FBZ0MsRUFBRSxtQkFBbUIsQ0FBQyxDQUFDO0FBQ25FLFVBQUksQ0FBQyx1QkFBdUIsR0FBRyxJQUFJLENBQUM7S0FDckM7O0FBRUQscUJBQWlCLEVBQUUsS0FBSyxDQUFDLFNBQVMsQ0FBQyxVQUFTLEtBQUssRUFBRTtBQUFFLFVBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7S0FBRSxDQUFDLEVBQzlFLENBQUM7O0FBRUYsU0FBTyxLQUFLLENBQUM7Q0FDZCxDQUFDIiwiZmlsZSI6IlIuQXN5bmMuanMiLCJzb3VyY2VzQ29udGVudCI6WyJyZXF1aXJlKCc2dG81L3BvbHlmaWxsJyk7XG5jb25zdCBQcm9taXNlID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbm1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24oUikge1xyXG4gIGNvbnN0IF8gPSBSLl87XHJcbiAgY29uc3QgcmVxdWVzdEFuaW1hdGlvbkZyYW1lID0gcmVxdWlyZSgncmFmJyk7XHJcblxyXG4gIHJlcXVpcmUoJ3NldGltbWVkaWF0ZScpO1xyXG5cclxuICBmdW5jdGlvbiBjbGVhckFuaW1hdGlvbkZyYW1lKGhhbmRsZSkge1xyXG4gICAgcmVxdWVzdEFuaW1hdGlvbkZyYW1lLmNhbmNlbChoYW5kbGUpO1xyXG4gIH1cclxuXHJcbiAgY29uc3QgQXN5bmMgPSB7XHJcbiAgICBpZk1vdW50ZWQoZm4pIHtcclxuICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICBfLmRldigoKSA9PiB0aGlzLl9Bc3luY01peGluLnNob3VsZC5iZS5vayk7XHJcbiAgICAgICAgaWYoIXRoaXMuX0FzeW5jTWl4aW5IYXNVbm1vdW50ZWQpIHtcclxuICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xyXG4gICAgICAgIH1cclxuICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2RlZmVycmVkSW1tZWRpYXRlKGZuKSB7XHJcbiAgICAgIHJldHVybiAoKSA9PiB7XHJcbiAgICAgICAgbGV0IGFyZ3MgPSBhcmd1bWVudHM7XHJcbiAgICAgICAgbGV0IGlkID0gXy51bmlxdWVJZCgnc2V0SW1tZWRpYXRlJyk7XHJcbiAgICAgICAgbGV0IHEgPSBzZXRJbW1lZGlhdGUoKCkgPT4ge1xyXG4gICAgICAgICAgZGVsZXRlIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRJbW1lZGlhdGVzW2lkXTtcclxuICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTtcclxuICAgICAgICB9KTtcclxuICAgICAgICB0aGlzLl9Bc3luY01peGluUXVldWVkSW1tZWRpYXRlc1tpZF0gPSBxO1xyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2RlZmVycmVkQW5pbWF0aW9uRnJhbWUoZm4pIHtcclxuICAgICAgcmV0dXJuICgpID0+IHtcclxuICAgICAgICBsZXQgYXJncyA9IGFyZ3VtZW50cztcclxuICAgICAgICBsZXQgaWQgPSBfLnVuaXF1ZUlkKCdzZXRJbW1lZGlhdGUnKTtcclxuICAgICAgICBsZXQgcSA9IHJlcXVlc3RBbmltYXRpb25GcmFtZSgoKSA9PiB7XHJcbiAgICAgICAgICBkZWxldGUgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lc1tpZF07XHJcbiAgICAgICAgICByZXR1cm4gZm4uYXBwbHkodGhpcywgYXJncyk7XHJcbiAgICAgICAgfSk7XHJcbiAgICAgICAgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lc1tpZF0gPSBxO1xyXG4gICAgICAgIHJldHVybiBpZDtcclxuICAgICAgfTtcclxuICAgIH0sXHJcblxyXG4gICAgX2RlZmVycmVkVGltZW91dChkZWxheSkge1xyXG4gICAgICByZXR1cm4gKGZuKSA9PiAoKSA9PiB7XHJcbiAgICAgICAgbGV0IGFyZ3MgPSBhcmd1bWVudHM7XHJcbiAgICAgICAgbGV0IGlkID0gXy51bmlxdWVJZCgnc2V0VGltZW91dCcpO1xyXG4gICAgICAgIGxldCBxID0gc2V0VGltZW91dCgoKSA9PiB7XHJcbiAgICAgICAgICBkZWxldGUgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZFRpbWVvdXRzW2lkXTtcclxuICAgICAgICAgIHJldHVybiBmbi5hcHBseSh0aGlzLCBhcmdzKTtcclxuICAgICAgICB9LCBkZWxheSk7XHJcbiAgICAgICAgdGhpcy5fQXN5bmNNaXhpblF1ZXVlZFRpbWVvdXRzW2lkXSA9IHE7XHJcbiAgICAgICAgcmV0dXJuIHE7XHJcbiAgICAgIH07XHJcbiAgICB9LFxyXG5cclxuICAgIGRlZmVycmVkKGZuLCBkZWxheSkge1xyXG4gICAgICBsZXQgaWZuID0gUi5Bc3luYy5pZk1vdW50ZWQoZm4pO1xyXG4gICAgICBpZighZGVsYXkpIHtcclxuICAgICAgICByZXR1cm4gUi5Bc3luYy5fZGVmZXJyZWRJbW1lZGlhdGUoaWZuKTtcclxuICAgICAgfVxyXG4gICAgICBlbHNlIHtcclxuICAgICAgICByZXR1cm4gUi5Bc3luYy5fZGVmZXJyZWRUaW1lb3V0KGlmbiwgZGVsYXkpO1xyXG4gICAgICB9XHJcbiAgICB9LFxyXG5cclxuICAgIGRlZmVycmVkQW5pbWF0aW9uRnJhbWUoZm4pIHtcclxuICAgICAgbGV0IGlmbiA9IFIuQXN5bmMuaWZNb3VudGVkKGZuKTtcclxuICAgICAgcmV0dXJuIFIuQXN5bmMuX2RlZmVycmVkQW5pbWF0aW9uRnJhbWUoaWZuKTtcclxuICAgIH0sXHJcbiAgfTtcclxuXHJcbiAgQXN5bmMuTWl4aW4gPSB7XHJcbiAgICBfQXN5bmNNaXhpbjogdHJ1ZSxcclxuICAgIF9Bc3luY01peGluSGFzVW5tb3VudGVkOiBmYWxzZSxcclxuICAgIF9Bc3luY01peGluUXVldWVkVGltZW91dHM6IG51bGwsXHJcbiAgICBfQXN5bmNNaXhpblF1ZXVlZEltbWVkaWF0ZXM6IG51bGwsXHJcbiAgICBfQXN5bmNNaXhpblF1ZXVlZEFuaW1hdGlvbkZyYW1lczogbnVsbCxcclxuXHJcbiAgICBjb21wb25lbnRXaWxsTW91bnRjb21wb25lbnRXaWxsTW91bnQoKSB7XHJcbiAgICAgIHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRUaW1lb3V0cyA9IHt9O1xyXG4gICAgICB0aGlzLl9Bc3luY01peGluUXVldWVkSW1tZWRpYXRlcyA9IHt9O1xyXG4gICAgICB0aGlzLl9Bc3luY01peGluUXVldWVkQW5pbWF0aW9uRnJhbWVzID0ge307XHJcbiAgICB9LFxyXG5cclxuICAgIGNvbXBvbmVudFdpbGxVbm1vdW50KCkge1xyXG4gICAgICBfLmVhY2godGhpcy5fQXN5bmNNaXhpblF1ZXVlZFRpbWVvdXRzLCBjbGVhclRpbWVvdXQpO1xyXG4gICAgICBfLmVhY2godGhpcy5fQXN5bmNNaXhpblF1ZXVlZEltbWVkaWF0ZXMsIGNsZWFySW1tZWRpYXRlKTtcclxuICAgICAgXy5lYWNoKHRoaXMuX0FzeW5jTWl4aW5RdWV1ZWRBbmltYXRpb25GcmFtZXMsIGNsZWFyQW5pbWF0aW9uRnJhbWUpO1xyXG4gICAgICB0aGlzLl9Bc3luY01peGluSGFzVW5tb3VudGVkID0gdHJ1ZTtcclxuICAgIH0sXHJcblxyXG4gICAgc2V0U3RhdGVJZk1vdW50ZWQ6IEFzeW5jLmlmTW91bnRlZChmdW5jdGlvbihzdGF0ZSkgeyB0aGlzLnNldFN0YXRlKHN0YXRlKTsgfSksXHJcbiAgfTtcclxuXHJcbiAgcmV0dXJuIEFzeW5jO1xyXG59O1xyXG4iXSwic291cmNlUm9vdCI6Ii9zb3VyY2UvIn0=