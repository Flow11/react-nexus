React on Rails API Reference
============================

0. Assumptions
0. `R` Top-level API
0. `R.Debug`
0. `R.App`
0. `R.Client`
0. `R.RenderServer`
0. `R.Flux`
0. `R.Store`
0. `R.EventEmitter`
0. `R.Dispatcher`
0. `R.Root`
0. `R.Component`
0. `R.Style`
0. `R.Stylesheet`
0. `R.Uplink`
0. `R.SimpleUplinkServer`
0. `R.Lock`
0. `React.Children` (extensions)
0. `React.createClass` (extensions)
0. `R.Pure`
0. `R.Async`
0. `R.Animate`
0. `R.Query` (`R.$`)
0. `R.Router`
0. `R.History`
0. `R.Localize`
0. `R.Window`
0. `R.XWindow`
0. `R.Cordova`


### Assumptions

The magic of `React on Rails` essentially relies on the same assumptions as `React`.
However, it makes the additional following assumptions:

- Client is run from an HTML page generated by render server.
- Components don't trigger side-effects (timeouts, etc.) unless they explicitly clean after themselves
- All components code is isomorphic, except when its not (eg. reaction to DOM events, `componentDidMount`, etc.)
- Don't mess with the frameworks' internals (anything prefixed with either `_` or `__`)
- Client `guid`s should be kept secret. Don't share any client `guid` publicly, if you need to identify client amongst them
hash their guids first.
- Installing `R` using `R.install(params)` should be the or very close to the first line of your entry points, since it must patch React internals
before any call to `React.createClass` is performed.

### Top-level API

The top-level API regroups several cross-concern utilities, and the `install` static method.

#### `R.install(Object params)`
Sets up the environment for `React on Rails`.
It requires reference to the `React` object and a reference to the `instantiateReactComponent` methods.
You must call this method before any call to `React.createClass`.
- `params.React: Object`: typically the value of `require("react")`.
- `params.instantiateReactComponent: Function`: typically the value of `require("react/lib/instiantiateReactComponent")
- `params.mode: String` (Optional) Either `production` or `development`. Defaults to `development`.

`install` dynamically injects a reference to the React object, and therefore the package doesn't have `react` as an explicit `npm`
dependency. However, it can only be used in a program which effectively requires `react` and pass it as `param.React`.

#### `R.scope(Function fn, Object ctx): Function`
Faster implementation of `Function.prototype.bind` for the special case where no arguments are bound, only
the context. See [this jsperf](http://jsperf.com/bind-vs-scope-perf).

#### `R.record(String key, Any val): Object`
Returns an Object with a single key-value pair.

#### `R.noopThunk(): Function(Function)`
Returns a thunk that defers its resolution to the next macrotask tick.

#### `R.timeoutThunk(Number delay): Function(Function)`
Returns a thunk that defers its resolution of a given delay.

#### `R.constantThunk(Any val): Function(Function)`
Returns a thunk that defers its resolution to the next macrotask tick and resolve to the given value.

#### `R.callWith(...args): Function(Function)`
Returns a callback that applies the arguments passed to `R.callWith` to its unique arguments.
Useful when iterating a collection of functions.

#### `R.isServer(): Boolean`
Returns true iff the current runtime is in the server (node).

#### `R.isClient(): Boolean`
Returns true iff the current runtime is a browser.

#### `R.ifServer(Function fn)`
Runs `fn` and returns its value iff the runtime is in the server. Otherwise, returns `undefined`.

#### `R.ifClient(Function fn)`
Runs `fn` and returns its value iff the runtime is in the browser. Otherwise, returns `undefined`.

#### `R.startsWith(String str, String prefix): Boolean`
Return true iff `str` starts with `prefix`.

#### `R.hash(String str ): String`
Returns a cryptographically secure hash of `str`. See [`sha256`](https://www.npmjs.org/package/sha256).

#### `R.guid(String prefix=""): String`
Returns a freshly generated [GUID](http://en.wikipedia.org/wiki/Globally_unique_identifier), optionally prefixed by `prefix`.
It is used internally for generating unique client ids.

#### `R.Base64.encode(String s): String`
Encodes `s` to from utf-8 to Base64.

#### `R.Base64.decode(String s): String`
Decodes `s` from Base64 to utf-8.

### `R.Debug`
Debugging utilities, yielding both safe assertions during development and fast execution in production, without changing a single line of code.

#### `R.Debug.setMode(String mode)`
Sets the internal mode and `process.env.NODE_ENV` to `mode` which should be either `development` or `production`.
In `development` mode, Promises and immediates (used by `regenerator`) yield long stack traces.

#### `R.Debug.isDev(): Boolean`/`R.Debug.isProd(): Boolean`
Booleans for the current mode.

#### `R.Debug.dev(Function fn)/R.Debug.prod(Function fn)`
Runs `fn`, only if the current mode is `development` (for `R.Debug.dev`) or `production` (for `R.Debug.prod`).
Guard all development-only assertions inside this directive, so they don't get executed at all in the other mode.
```js
R.Debug.dev(function() {
    assert(null !== 0, "Something is very wrong.");
});
```

#### `R.Debug.breakpoint()`
Runs a `debugger` statement.

#### `R.Debug.stackTrace(): String`
Returns a stack trace string.

#### `R.Debug.display(String name, Object obj)`
Pretty-prints a deep inspection of `obj`, iterating over all its properties (even inherited).
Output is wrapped with a clean identifier based on `name`.

#### `R.Debug.fail(Error err)`
Rethrow `err`.

#### `R.Debug.check(...args)`
Calls `assert` with the same arguments `args`. In case of failure, throws in `development` mode,
or outputs with `console.error` in `production` mode.

#### `R.Debug.extendError(Error err, String message): Error err`
Extends an error, augmenting it with an additional message (useful for error catching cascades).
Remember that `if(err) throw err;`/`if(err) return done(err); is an anti-pattern.
Provide useful informations to your caller.

#### `R.Debug.rethrow(String message)`
Returns a node-style callback which simply rethrows the error augmented with `message` using `R.Debug.extendError`.

### `R.App`

A `React on Rails` App represents the top level description of your application.
`App` is a constructor, and an instance of `App` contains:
- a `Flux` constructor,
- a root component constructor,
- a template for the HTML container of your app,
- an asynchronous initializer, executed to perform tasks before rendering the template for a client,
- a collection of template static vars,
- a collection of React on Rails plugins to install on each client,
- a collection of template libs to use as template helpers.

#### `R.App.createApp(Object specs): Function(): new App`

Returns an `App` constructor (a Function that returns an `App` instance when called with `new`) with the provided specs.
- `specs.fluxClass(): new R.Flux` `R.Flux` constructor. A new instance will be created for each client.
- `specs.rootClass(): new ReactComponent`: `ReactComponent` constructor, which should mix in `R.Root.Mixin`. Will be mounted as the root component of the app.
- `specs.template(Object vars, Object libs): String`: a template function which should return the HTML page to send to each client.
You should use `R.App.defaultTemplate` or implement your own very closely.
The `<body>` block of the generated HTML must contain the following blocks:
```html
<div id="ReactOnRails-App-Root">
    <%= vars.rootHtml %>
</div>
```
and
```html
<script type="text/javascript">
    window.__ReactOnRails = {};
    window.__ReactOnRails.serializedFlux = "<%= vars.serializedFlux %>";
    window.__ReactOnRails.serializedHeaders = "<%= vars.serializedHeaders %>";
    window.__ReactOnRails.guid = "<%= vars.guid %>";
</script>
```
for the magic to happen.
- `specs.bootstrapTEmplateVarsInServer*(Object req, Object headers, String guid): Object`: async generator that should return an hash of vars to be passed to the template function.
This is your opportunity to parse request headers or client guid to customize the generated HTML.
- `specs.vars: Object`: optional hash of static vars that will be passed to the template function in addition to the vars computed from `bootstrapTemplateVarsInServer`.
- `specs.plugins: Array|Object`: optional collection of plugins. Plugins are usually created with `R.App.createPlugin` and implement application-wide behaviour, such as `History` or `Cordova`.
- `specs.templateLibs: Object`: optional collection of libs to pass the template function. Defaults to `{ _: require('lodash') }` since `lodash` is so awesome.

#### `R.App#renderToStringInServer*(Object req)` (Server-only)
Async generator that returns the HTML to sent is reponse to a `req` request Object, typically passed by an `express` request handler.
Internally, it does the following:
- generate a fresh `guid`,
- instanciate a new `Flux` instance using `new specs.fluxClass()`,
- asynchronously initialize the flux by yielding `flux.bootstrapInServer(req, req.headers, guid)`,
- install all plugins, invoking `plugin.installInServer(flux, req)` on each,
- prefetch the dependencies of the app by recursively exploring the dependencies of `this.rootClass(props={ flux: flux })`,
- render `this.rootClass(props={ flux: flux })` to string with pre-injected dependencies,
- serialize the flux,
- asynchronously compute additional template vars by yielding `specs.bootstrapTemplateVarsInServer(req)`,
- inject everything into the template to generate the HTML.

#### `R.App#renderIntoDocumentInClient*(window)` (Client-only)
Async generator that mounts the app into the document, reusing the crumbs left by the server-side rendering.
Internally, it does the following:
- instanciate a new `Flux` instance using `new this.specs.fluxClass()`,
- retrieve the `headers` and `guid` from the globals injected by `renderToStringInServer` into `window.__ReactOnRails`,
- asynchronously initialize the flux by yielding `flux.bootstrapInClient(window, headers, guid)`,
- unserialize the flux,
- install all plugins, invoking `plugin.installInClient(flux, window)` on each,
- mount `this.rootClass(props={ flux: flux })` into `window.document.getElementById('ReactOnRails-App-Root')`.

#### `R.App.createPlugin(Object specs): Function(): new Plugin`
Returns a `Plugin` constructor (a Function that returns a new `Plugin` instance when called with `new`) with the provided specs.
`specs.displayName: String`: Name of the plugin, for debugging purposes,
`specs.installInServer*(Flux flux, Object req)`: asynchronously initialize the plugin in the server,
`specs.installInClient*(Flux flux, Object window)`: asynchronously initialize the plugin in the client.

#### `R.App.defaultTemplate`
Sane default template.
Customizable vars:
- `lang: String`: HTML lang, eg. "en". If present, injected into `<html>`'s `lang` attribute. Otherwise this attribute is omitted.
- `charset: String`: meta charset, defaults to `utf-8`. Injected as a `<meta>` inside `<head>`.
- `description: String`: meta description. If present, injected as a `<meta>` inside `<head>`.
- `viewport: String`: meta viewport, defaults to `width=device-width, initial-scale=1`. Injected as a `<meta>` inside `<head>`.
- `title: String`: injected into `<title>`.
- `stylesheets: Array|Object`: collection of stylesheets URL. Each stylesheet results in a `<link rel="stylesheet" type="text/css" />`.
- `scripts: Array|Object`: collection of scripts URL. Each script results in a `<script type="text/javascript">`. You most likely
will need to put the URL to your client build here.

### `R.Client`

A `React on Rails` Client represents the projection of an application in the browser. It's just a containter with only one purpose, mounting an app into
the current window.

#### `R.Client(Function App): new Client` (Client-only)
Constructs a new instance of Client, wrapping an instance of `new App()`.
Upon instantiating, it also attaches the local `React` instance to `window`, allowing the `React dev tools` to work properly in Chrome.
It is the single point of entry of a client.

#### `R.Client#mount*()`
Async generator that mounts an instance of the app into the current window.

### `R.RenderServer`

A `React on Rails` Render Server is in charge of interpreting an HTTP request, render the requested page server-side, and serve it back to the client.
Like `R.Client`, `R.RenderServer` is actually just an `App` containers, leveraging its internal methods to do the heavylifting.

#### `R.RenderServer(Function App): new RenderServer` (Server-only)
Constructs a new instance of RenderServer, wrapping an instance of `new App()`.

#### `R.RenderServer#middleware(Object request, Object response)`
HTTP server/Connect/express middleware that attempts to rendder the page for the given request.
If successful, replies with `200` and the generated HTML. Otherwise, replies with `500` and an error description.

### `R.Flux`

A `React on Rails` Flux is a generalization of the canonical Flux pattern. It encapsulates all the allowed side-effects of an app, such as external data dependencies,
so that all the components are pure with respect to its Flux.
To allow server side rendering to happen, the Flux must be serializable, and constructable either in the server or in the client. Thus, it is designed from the bottom-up
to provide all the required features while remaining serializable and isomorphically constructable.
A Flux instance interfaces 3 collections:
- a collection of stores,
- a collection of event emitters,
- a collection of dispatchers.

Inside an App, each components can interact with the Flux instance using Flux.Mixin (generally via Root.Mixin or Component.Mixin).

#### `R.Flux.createFlux(Object specs): Function(): new Flux`
Returns a `Flux` constructor (a Function which returns a Flux instance when called with `new`) with the provided specs.
- `specs.bootstrapInClient*(Object request, Object headers, String guid)`: Async generator which performs the initialization of the flux in the client.
- `specs.bootstrapInServer*(Object window, Object headers, String guid)`: Async generator which performs the initilization of the flux in the server.
- `specs.destroyInClient()`: (Optional) Free resources allocated in `bootstrapInClient*()`. Defaults to noop.
- `specs.destroyInServer()`: (Optional) Free resources allocated in `bootstrapInServer*()`. Defaults to noop.
It is expected that after bootstrapping on either the client or the server, the state of the flux is the same, ie. ensuring isomorphic semantics.

#### `R.Flux.Mixin: Object`
React Component Mixin interfacing the current flux.
This mixin expects the component to implement `this.getFlux(): Flux`, which is usually implement by either `R.Root.Mixin` or `R.Component.Mixin`.

#### `R.Flux.Mixin#getFluxStoreSubscriptions(Object props): Object`
Implement this lifecycle method to declare `flux stores -> component state` bindings, defaulting to no bindings (`{}` returned).
For each `(String key, String value)`in the collection (represented by an Object), then:
- `key` is like `storeName:/storeKey`, eg. "myStore://myLocation" means "key `/myLocation` in store named `myStore`".
- `value` is the state key in which the store value will be injected.
For example (using ES6 [computed property keys](https://github.com/lukehoban/es6features#enhanced-object-literals) and [templates strings](https://github.com/lukehoban/es6features#template-strings)):
```js
getFluxStoreSubscriptions(props) {
    return {
        "memory://currentPage": "page",
        [`uplink://user/${props.userId}`]: "user",
    };
}
```
Such a component will have the value keyed by `/currentPage` in the `memory` store injected into `this.state.page`,
and the value keyed by `/user/${props.userId}` in the `uplink` store injected into `this.state.user`.
Note that not only will the values injected at pre-rendering time, but also after mounting, and re-injected whenever the store is updated.
This pattern effectively ensures the automatic liveness of the binding.

Much like `getInitialState`, expect `getFluxStoreSubscriptions` to be called often, so it should be synchronous, fast, and free from side effects.

#### `R.Flux.Mixin#getFluxEventEmittersListeners(Object props): Object`
Similar to `R.Flux.Mixin#getFluxStoreSubscriptions`, but describes bindings of event emitters to callbacks.
For each `(String key, Function value)` in the collection (represented by an Object), then:
- `key` is like `eventEmitterName:/eventEmitterKey`, eg. `myEventEmitter://myEventName` means "key `/myEventName` in event emitter named `myEventEmitter`".
- `value` is the callback function that will be invoked anytime the event is emitted.
For example:
```js
getEventEmittersListeners(props) {
    return {
        "memory://History/navigate": function hasNavigated(params) { console.log("I have navigated to " + params.path); },
    };
}
```

#### `R.Flux.Mixin#fluxStoreWillUpdate(String stateKey, String location, Any val, Any previousVal)`
#### `R.Flux.Mixin#fluxStoreDidUpdate(String stateKey, String location, Any val, Any previousVal)`
#### `R.Flux.Mixin#fluxEventEmitterWillEmit(String eventEmitterName, String eventName, Object params)`
#### `R.Flux.Mixin#fluxEventEmitterDidEmit(String eventEmitterName, String eventName, Object params)`
Callback methods called before/after flux updates/emits, much like `componentWillUpdate` of `componentDidUpdate`.
Under usual circumstances you won't need them, but they can prove handy.

#### `R.Flux.Mixin#dispatch*(String location, Object params)`
Asynchrnously dispatches an action. `location` must be like `dispatcherName:/actionName`, eg. `myDispatcher://myAction` represents the
action named `/myAction` in the dispatcher `myDispatcher`.
Be cautious if you do something after yielding, since at this point the component might be unmounted (see `R.Async.Mixin#IfMounted`).

#### `R.Flux#startInjectingFromStores()`
#### `R.Flux#stopInjectingFromStores()`
Sets/unsets the flag telling all the flux-mixed-in components to attempt to inject pre-fetched values from the cache.
Used for pre-rendering magic.
Not intented for public use.

#### `R.Flux#serialize(String str)`
#### `R.Flux#unserialize(): String`
Serializes/unserializes the data inside the flux stores.
Recursively serializes/unserializes each store.
Used for pre-rendering magic.
Not intented for public use.

#### `R.Flux#getStore(String storeName): Store`
#### `R.Flux#registerStore(String storeName, Store store)`
#### `R.Flux#getEventEmitter(String): EventEmitter`
#### `R.Flux#registerEventEmitter(String eventEmitterName, EventEmitter eventEmitter)`
#### `R.Flux#getDispatcher(String dispatcherName): Dispatcher`
#### `R.Flux#registerDispatcher(String dispatcherName, Dispatcher dispatcher)`
Getters/setters for the stores/event emitters/dispatchers of the flux instance.
You probably won't need to use these directly, as location-formatted ("mystore://mykey")
and higher-level method (methods of `R.Flux.Mixin`) are usually preferred.

#### `R.Flux#destroy()`
Clears the store by calling either `this.destroyInServer` or `this.destroyInClient` and
recursively applying `destroy` on each store/event emittre/dispatcher.
Used for pre-rendering magic.
Not intented for public use.

### `R.Store`

### `R.EventEmitter`

### `R.Dispatcher`

### `R.Root`

### `R.Component`

### `R.Style`

### `R.Stylesheet`

### `R.Uplink`

### `R.SimpleUplinkServer`

### `R.Lock`

### `React.Children`

### `React.createClass`

### `R.Pure`

### `R.Async`

### `R.Animate`

### `R.Query` aka `R.$`

### `R.Router`

### `R.History`

### `R.Localize`

### `R.Window`

### `R.Window`

### `R.XWindow`

### `R.Cordova`
